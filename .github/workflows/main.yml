name: Build Android APK

on:
  push:
    branches: ["main"]

# Necesario para permitir que se creen releases y se suban archivos
permissions:
  contents: write

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
      # --- Checkout del repositorio ---
      - name: Checkout repository
        uses: actions/checkout@v4


      # --- Node requerido por Capacitor ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install npm deps
        run: npm ci


      # --- Build del frontend (Vue + Ionic) ---
      - name: Build web assets
        run: npm run build


      # --- Sincronizar con Android ---
      - name: Sync Capacitor
        run: npx cap sync android


      # --- JAVA 21 para Gradle / Android ---
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: gradle


      # --- Dar permisos al gradlew ---
      - name: Grant execute permission to gradlew
        run: chmod +x android/gradlew


      # --- Build del APK ---
      - name: Build release APK
        run: |
          cd android
          ./gradlew assembleRelease


      # --- Mostrar todos los APK generados ---
      - name: Show APK output directories
        run: ls -R android/app/build/outputs/apk/


      # --- Subir APK como Release ---
      - name: Upload Release APK
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "latest"
          name: "Android Release"
          files: |
            android/app/build/outputs/apk/release/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
